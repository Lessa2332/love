<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>üéÉ –ì–∞—Ä–±—É–∑–æ–≤–µ —Å–≤—ñ—Ç–ª–æ</title>

  <style>
    body { margin: 0; overflow: hidden; background-color: black; font-family: "Comic Sans MS", cursive; }
    #loader, #startBtn { position: absolute; left: 50%; transform: translateX(-50%); z-index: 9999; }
    #loader { top: 10px; color: #ffb347; font-size: 18px; background: rgba(11,11,29,0.9); padding: 8px 12px; border-radius: 8px; }
    #hint { position: absolute; top: 60px; left: 50%; transform: translateX(-50%); padding: 12px 18px; color: #fff; background: rgba(255,140,0,0.9); border-radius: 16px; box-shadow: 0 0 20px #ffb347; font-size: 18px; display:none; z-index: 1000; }
    #startBtn { top: 110px; }
    button { background: #ff8c00; color: white; border: none; padding: 10px 16px; font-size: 16px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.4); cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
  </style>
</head>

<body>
  <div id="loader">üéÉ –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä!</div>
  <div id="hint">üé§ –°–∫–∞–∂–∏ —â–æ—Å—å –≥–∞—Ä–±—É–∑—É ‚Äî –≤—ñ–Ω –∑–∞—Å–≤—ñ—Ç–∏—Ç—å—Å—è!</div>
  <div id="startBtn" style="display:none;"><button id="btnStart">–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –∑–≤—É–∫ (–ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–æ–∑–≤—ñ–ª)</button></div>

  <!-- ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–û: –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ A-Frame –ü–ï–†–®–ò–ú –±–µ–∑ defer -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.6.0/dist/aframe.min.js"></script>
  <!-- ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–û: MindAR –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è –ü–Ü–°–õ–Ø A-Frame -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <a-scene
    mindar-image="imageTargetSrc: ./targets.mind; autoStart: true;"
    color-space="sRGB"
    embedded
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    loading-screen="enabled: false"
    renderer="colorManagement: true; alpha: true;"
  >
    <a-assets>
      <a-asset-item id="pumpkinModel" src="./pumpkin.glb"></a-asset-item>
    </a-assets>

    <a-camera position="0 0 0.8"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0" id="target-entity">
      <a-gltf-model id="pumpkin" src="#pumpkinModel" position="0 -0.1 0" rotation="0 180 0" scale="0.5 0.5 0.5"></a-gltf-model>

      <a-light id="pumpkinLight" type="point" color="#FFA500" position="0 0.2 0" intensity="0.4" distance="3" decay="1"></a-light>

      <a-entity id="glowSphere" geometry="primitive: sphere; radius: 0.2;"
                material="color: #FF9900; opacity: 0.3; transparent: true;"
                position="0 0.2 0" scale="1 1 1"></a-entity>

      <a-light type="ambient" color="#ffcc88" intensity="0.4"></a-light>
    </a-entity>

    <a-sky color="#0b0b1d"></a-sky>
    <a-light type="hemisphere" color="#fff4e0" ground-color="#ff6600" intensity="0.2"></a-light>
  </a-scene>

  <script>
    // ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–û: –ß–µ–∫–∞—î–º–æ –ø–æ–∫–∏ –≤—Å—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–∞—Ç—å—Å—è
    window.addEventListener('DOMContentLoaded', function() {
      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∏—Å—å –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏
      if (typeof AFRAME === 'undefined') {
        console.error('A-Frame –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ');
        document.getElementById('loader').textContent = '‚ùå –ü–æ–º–∏–ª–∫–∞: A-Frame –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ';
        return;
      }
      
      if (typeof MINDAR === 'undefined') {
        console.error('MindAR –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ');
        document.getElementById('loader').textContent = '‚ùå –ü–æ–º–∏–ª–∫–∞: MindAR –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ';
        return;
      }

      // ‚úÖ –¢–µ–ø–µ—Ä —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –Ω–∞—à –¥–æ–¥–∞—Ç–æ–∫
      const loader = document.getElementById("loader");
      const hint = document.getElementById("hint");
      const startBtnWrap = document.getElementById("startBtn");
      const btnStart = document.getElementById("btnStart");
      const targetEntity = document.getElementById("target-entity");
      const pumpkinLight = document.getElementById("pumpkinLight");
      const glowSphere = document.getElementById("glowSphere");

      let isTargetVisible = false;
      let audioInitialized = false;
      let analyser = null;
      let dataArray = null;
      let audioContext = null;

      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –µ–ª–µ–º–µ–Ω—Ç–∏ –∑–Ω–∞–π–¥–µ–Ω—ñ
      if (!targetEntity) {
        console.error('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ target-entity');
        return;
      }

      function updateUI() {
        if (isTargetVisible) {
          loader.style.display = "none";
          hint.style.display = "block";
          if (!audioInitialized) startBtnWrap.style.display = "block";
        } else {
          loader.style.display = "block";
          hint.style.display = "none";
          startBtnWrap.style.display = "none";
        }
      }

      function resetLights() {
        if (pumpkinLight) pumpkinLight.setAttribute("intensity", "0.4");
        if (glowSphere) {
          glowSphere.setAttribute("scale", "1 1 1");
          glowSphere.setAttribute("material", "opacity", "0.3");
        }
      }

      targetEntity.addEventListener("targetFound", () => {
        console.log("üéØ –ú–∞—Ä–∫–µ—Ä –∑–Ω–∞–π–¥–µ–Ω–æ!");
        isTargetVisible = true;
        updateUI();
      });

      targetEntity.addEventListener("targetLost", () => {
        console.log("üéØ –ú–∞—Ä–∫–µ—Ä –≤—Ç—Ä–∞—á–µ–Ω–æ!");
        isTargetVisible = false;
        updateUI();
        resetLights();
      });

      btnStart.addEventListener("click", async () => {
        try {
          btnStart.textContent = "–ó–∞–ø—É—Å–∫–∞—î–º–æ...";
          btnStart.disabled = true;
          await initMic();
          audioInitialized = true;
          startBtnWrap.style.display = "none";
          hint.textContent = "üé§ –ì–æ–≤–æ—Ä–∏ —â–æ—Å—å ‚Äî –≥–∞—Ä–±—É–∑ –∑–∞—Å–≤—ñ—Ç–∏—Ç—å—Å—è!";
        } catch (err) {
          console.error("–ü–æ–º–∏–ª–∫–∞ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞:", err);
          btnStart.textContent = "–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É";
          btnStart.disabled = false;
          alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –º—ñ–∫—Ä–æ—Ñ–æ–Ω. –ü–µ—Ä–µ–≤—ñ—Ä –¥–æ–∑–≤–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞.");
        }
      });

      async function initMic() {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: false
          } 
        });
        
        const AudioContextClass = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContextClass();
        const src = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        analyser.smoothingTimeConstant = 0.7;
        src.connect(analyser);

        dataArray = new Uint8Array(analyser.frequencyBinCount);
        console.log("üé§ –ú—ñ–∫—Ä–æ—Ñ–æ–Ω –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ!");
      }

      function animateLight() {
        if (analyser && dataArray && isTargetVisible) {
          analyser.getByteFrequencyData(dataArray);
          const avg = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
          const loudness = Math.min(Math.max(avg / 80, 0), 1.5);
          const intensity = Math.min(loudness * 3, 3);
          const glowSize = 1 + loudness * 0.8;

          if (pumpkinLight) pumpkinLight.setAttribute("intensity", (0.2 + intensity).toFixed(2));
          if (glowSphere) {
            glowSphere.setAttribute("scale", `${glowSize} ${glowSize} ${glowSize}`);
            glowSphere.setAttribute("material", "opacity", (0.2 + loudness * 0.3).toFixed(3));
          }
        }
        requestAnimationFrame(animateLight);
      }

      // –ó–∞–ø—É—Å–∫–∞—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é
      animateLight();
      console.log("üöÄ –î–æ–¥–∞—Ç–æ–∫ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ!");
    });
  </script>
</body>
</html>

