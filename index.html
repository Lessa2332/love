<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="AR-—Å—Ü–µ–Ω–∞ –∑—ñ —Å–≤—ñ—á–∫–æ—é –¥–ª—è –¥—ñ—Ç–µ–π">
    <title>üïØÔ∏è¬´–°–≤—ñ—á–∫–∞ –Ω–∞ –¥–æ–ª–æ–Ω—ñ¬ª üî•</title>

    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: transparent;
            font-family: 'Comic Neue', 'Comic Sans MS', cursive, sans-serif;
        }
        
        a-scene {
            width: 100% !important;
            height: 100% !important;
            position: fixed;
            top: 0;
            left: 0;
            background: transparent;
        }

        .arjs-loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(135, 206, 235, 0.2);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #FF4500;
            font-size: clamp(1.2em, 4vw, 1.8em);
            text-align: center;
            padding: 20px;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }

        .pulse { 
            animation: pulse 2s ease-in-out infinite; 
            margin-bottom: 15px;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 90%;
        }

        .sound-btn, .youtube-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9em;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            text-decoration: none;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .sound-btn { 
            background: linear-gradient(145deg, #4CAF50, #45a049);
            color: white; 
        }
        .sound-btn.off { 
            background: linear-gradient(145deg, #f44336, #da190b); 
        }
        .youtube-btn { 
            background: linear-gradient(145deg, #FF9800, #f57c00);
            color: white; 
        }
        .sound-btn:hover, .youtube-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="arjs-loader" id="loader">
        <div class="pulse">üïØÔ∏è –°–≤—ñ—á–∫–∞ –Ω–∞ –¥–æ–ª–æ–Ω—ñ üî•</div>
        <div>–ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä! üòä</div>
    </div>

    <a-scene
        mindar-image="imageTargetSrc: ./targets.mind;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        loading-screen="enabled: false"
        embedded
        renderer="colorManagement: true; physicallyCorrectLights: true;"
    >
        <a-assets>
            <audio id="bg-music" src="./message.mp3" preload="auto" loop></audio>
            <img id="flame-texture" src="https://cdn.jsdelivr.net/gh/aframevr/assets@master/common/images/particle.png" crossorigin="anonymous">
        </a-assets>

        <!-- –û—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è -->
        <a-light type="ambient" color="#FFFFFF" intensity="0.6"></a-light>
        <a-light type="directional" color="#FFFFFF" intensity="0.8" position="2 5 3"></a-light>

        <a-camera
            id="camera"
            position="0 0 0"
            look-controls="enabled: false"
            active="false"
        ></a-camera>

        <a-entity mindar-image-target="targetIndex: 0">
            <a-entity id="candle-container" position="0 0 0" scale="0.4 0.4 0.4" visible="false">
                <!-- –†–µ–∑–µ—Ä–≤–Ω–∞ —Å–≤—ñ—á–∫–∞, —è–∫—â–æ GLB –Ω–µ –ø—Ä–∞—Ü—é—î -->
                <a-cylinder id="candle-body" radius="0.15" height="1.2" color="#F5F5DC" roughness="0.8" position="0 0.6 0">
                    <a-animation attribute="rotation" dur="20000" to="0 360 0" repeat="indefinite" easing="linear"></a-animation>
                </a-cylinder>
                
                <!-- –í—ñ—Å–∫ -->
                <a-cone id="candle-wax" radius="0.18" height="0.15" color="#FFB74D" roughness="0.9" position="0 1.25 0"></a-cone>
                
                <!-- –î–∏–Ω–∞–º—ñ—á–Ω–µ –ø–æ–ª—É–º'—è -->
                <a-entity id="flame-container" position="0 1.35 0">
                    <a-entity id="flame-core" 
                              geometry="primitive: sphere; radius: 0.03"
                              material="color: #FFFF00; emissive: #FF4500; emissiveIntensity: 2"
                              animation="property: scale; to: 1.2 1.5 1.2; dur: 300; easing: easeInOutSine; dir: alternate; loop: true">
                    </a-entity>
                    
                    <a-entity id="flame-particles"
                              particle-system="preset: default; color: #FFA500, #FF4500, #FF0000; 
                              particleCount: 30; opacity: 0.8 0; size: 0.02 0.08; maxAge: 0.8; 
                              velocityValue: 0 0.8 0; velocitySpread: 0.1 0.3 0.1; 
                              accelerationValue: 0 0.4 0; accelerationSpread: 0.05 0.1 0.05">
                    </a-entity>
                </a-entity>

                <!-- –°–≤—ñ—Ç–ª–æ –≤—ñ–¥ –ø–æ–ª—É–º'—è -->
                <a-light id="flame-light" type="point" color="#FF4500" intensity="0.8" distance="3" position="0 1.35 0"
                         animation="property: intensity; to: 1.2; dur: 400; easing: easeInOutSine; dir: alternate; loop: true">
                </a-light>
            </a-entity>
        </a-entity>
    </a-scene>

    <div class="controls">
        <button id="sound-btn" class="sound-btn">–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫</button>
        <button id="mic-btn" class="sound-btn">–£–≤—ñ–º–∫–Ω—É—Ç–∏ –º—ñ–∫—Ä–æ—Ñ–æ–Ω</button>
        <a href="https://www.youtube.com/playlist?list=PL6UDFwT9TzFw5K8Tzu_OgsDz7vV3N9eY-" target="_blank" class="youtube-btn">YouTube SmartLessa</a>
    </div>

    <script>
        class CandleAR {
            constructor() {
                this.init();
            }

            init() {
                this.elements = {
                    loader: document.getElementById('loader'),
                    targetEntity: document.querySelector('[mindar-image-target]'),
                    candleContainer: document.getElementById('candle-container'),
                    flameContainer: document.getElementById('flame-container'),
                    flameLight: document.getElementById('flame-light'),
                    bgMusic: document.getElementById('bg-music'),
                    soundBtn: document.getElementById('sound-btn'),
                    micBtn: document.getElementById('mic-btn')
                };

                this.audio = {
                    context: null,
                    analyser: null,
                    dataArray: null,
                    micStream: null,
                    isMicActive: false
                };

                this.flameSettings = {
                    baseVelocityY: 0.8,
                    baseAccelerationY: 0.4,
                    baseSize: 0.08
                };

                this.setupEventListeners();
                this.fixHeight();
            }

            fixHeight() {
                document.body.style.height = window.innerHeight + 'px';
                window.addEventListener('resize', () => {
                    document.body.style.height = window.innerHeight + 'px';
                });
            }

            setupEventListeners() {
                // –í—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –º–∞—Ä–∫–µ—Ä–∞
                if (this.elements.targetEntity) {
                    this.elements.targetEntity.addEventListener('targetFound', () => this.onTargetFound());
                    this.elements.targetEntity.addEventListener('targetLost', () => this.onTargetLost());
                }

                // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è
                this.elements.soundBtn.addEventListener('click', () => this.toggleSound());
                this.elements.micBtn.addEventListener('click', () => this.toggleMicrophone());

                // –ñ–µ—Å—Ç–∏
                this.setupTouchGestures();
            }

            onTargetFound() {
                console.log("üéØ –ú–∞—Ä–∫–µ—Ä –∑–Ω–∞–π–¥–µ–Ω–æ!");
                this.elements.loader.style.display = 'none';
                this.elements.candleContainer.setAttribute('visible', 'true');
                this.startFlameAnimation();
                
                if (this.elements.bgMusic && this.elements.bgMusic.paused) {
                    this.playBackgroundMusic();
                }
            }

            onTargetLost() {
                console.log("‚ÑπÔ∏è –ú–∞—Ä–∫–µ—Ä –≤—Ç—Ä–∞—á–µ–Ω–æ.");
                this.elements.candleContainer.setAttribute('visible', 'false');
                this.stopBackgroundMusic();
                this.elements.loader.style.display = 'flex';
            }

            startFlameAnimation() {
                // –î–æ–¥–∞—î–º–æ –≤–∏–ø–∞–¥–∫–æ–≤—ñ –∫–æ–ª–∏–≤–∞–Ω–Ω—è –ø–æ–ª—É–º'—è
                this.flameContainer = this.elements.flameContainer;
                if (this.flameContainer) {
                    setInterval(() => {
                        const randomX = (Math.random() - 0.5) * 0.05;
                        const randomZ = (Math.random() - 0.5) * 0.05;
                        this.flameContainer.setAttribute('position', {
                            x: randomX,
                            y: 1.35 + Math.random() * 0.02,
                            z: randomZ
                        });
                    }, 100);
                }
            }

            async playBackgroundMusic() {
                try {
                    await this.elements.bgMusic.play();
                    this.elements.soundBtn.classList.remove('off');
                    this.elements.soundBtn.textContent = '–í–∏–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫';
                } catch (error) {
                    console.log("üîá –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –º—É–∑–∏–∫–∏:", error);
                }
            }

            stopBackgroundMusic() {
                if (this.elements.bgMusic && !this.elements.bgMusic.paused) {
                    this.elements.bgMusic.pause();
                }
            }

            toggleSound() {
                if (this.elements.bgMusic.paused) {
                    this.playBackgroundMusic();
                } else {
                    this.elements.bgMusic.pause();
                    this.elements.soundBtn.classList.add('off');
                    this.elements.soundBtn.textContent = '–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫';
                }
            }

            async toggleMicrophone() {
                if (!this.audio.isMicActive) {
                    await this.initMicrophone();
                } else {
                    this.deactivateMicrophone();
                }
            }

            async initMicrophone() {
                try {
                    this.audio.micStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: false
                        } 
                    });
                    
                    this.audio.context = new (window.AudioContext || window.webkitAudioContext)();
                    const source = this.audio.context.createMediaStreamSource(this.audio.micStream);
                    
                    this.audio.analyser = this.audio.context.createAnalyser();
                    this.audio.analyser.fftSize = 64;
                    this.audio.analyser.smoothingTimeConstant = 0.8;
                    
                    source.connect(this.audio.analyser);
                    this.audio.dataArray = new Uint8Array(this.audio.analyser.frequencyBinCount);
                    
                    this.audio.isMicActive = true;
                    this.elements.micBtn.classList.remove('off');
                    this.elements.micBtn.textContent = '–í–∏–º–∫–Ω—É—Ç–∏ –º—ñ–∫—Ä–æ—Ñ–æ–Ω';
                    
                    this.updateFlameFromAudio();
                    
                } catch (error) {
                    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞:', error);
                    alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–æ–∑–≤–æ–ª–∏.');
                }
            }

            deactivateMicrophone() {
                if (this.audio.micStream) {
                    this.audio.micStream.getTracks().forEach(track => track.stop());
                }
                if (this.audio.context) {
                    this.audio.context.close();
                }
                
                this.audio.isMicActive = false;
                this.elements.micBtn.classList.add('off');
                this.elements.micBtn.textContent = '–£–≤—ñ–º–∫–Ω—É—Ç–∏ –º—ñ–∫—Ä–æ—Ñ–æ–Ω';
                
                // –°–∫–∏–¥–∞—î–º–æ –ø–æ–ª—É–º'—è –¥–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞–Ω—É
                this.resetFlame();
            }

            updateFlameFromAudio() {
                if (!this.audio.isMicActive || !this.audio.analyser) return;

                this.audio.analyser.getByteFrequencyData(this.audio.dataArray);
                
                let sum = 0;
                for (let i = 0; i < this.audio.dataArray.length; i++) {
                    sum += this.audio.dataArray[i];
                }
                
                const average = sum / this.audio.dataArray.length;
                const volume = Math.min(1, average / 128);

                // –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ–ª—É–º'—è –Ω–∞ –æ—Å–Ω–æ–≤—ñ –≥—É—á–Ω–æ—Å—Ç—ñ
                this.updateFlameIntensity(volume);
                
                requestAnimationFrame(() => this.updateFlameFromAudio());
            }

            updateFlameIntensity(volume) {
                const intensity = 1 + volume * 3;
                const particleCount = 30 + Math.floor(volume * 50);
                const velocityY = this.flameSettings.baseVelocityY + volume * 0.5;
                
                const particles = document.getElementById('flame-particles');
                if (particles) {
                    particles.setAttribute('particle-system', {
                        particleCount: particleCount,
                        velocityValue: `0 ${velocityY} 0`,
                        size: `0.02 ${this.flameSettings.baseSize + volume * 0.1}`
                    });
                }

                if (this.elements.flameLight) {
                    this.elements.flameLight.setAttribute('intensity', 0.8 + volume * 2);
                }
            }

            resetFlame() {
                const particles = document.getElementById('flame-particles');
                if (particles) {
                    particles.setAttribute('particle-system', {
                        particleCount: 30,
                        velocityValue: `0 ${this.flameSettings.baseVelocityY} 0`,
                        size: `0.02 ${this.flameSettings.baseSize}`
                    });
                }

                if (this.elements.flameLight) {
                    this.elements.flameLight.setAttribute('intensity', 0.8);
                }
            }

            setupTouchGestures() {
                let startScale = 1;
                let initialDistance = 0;

                document.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 2) {
                        initialDistance = this.getTouchDistance(e.touches);
                        startScale = this.elements.candleContainer.object3D.scale.x;
                    }
                });

                document.addEventListener('touchmove', (e) => {
                    if (e.touches.length === 2) {
                        const currentDistance = this.getTouchDistance(e.touches);
                        const scaleFactor = currentDistance / initialDistance;
                        const newScale = Math.max(0.2, Math.min(2, startScale * scaleFactor));
                        
                        this.elements.candleContainer.object3D.scale.setScalar(newScale);
                    }
                });
            }

            getTouchDistance(touches) {
                const dx = touches[0].pageX - touches[1].pageX;
                const dy = touches[0].pageY - touches[1].pageY;
                return Math.sqrt(dx * dx + dy * dy);
            }
        }

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–æ–¥–∞—Ç–∫—É
        document.addEventListener('DOMContentLoaded', () => {
            new CandleAR();
        });

        // –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
        });
    </script>
</body>
</html>
