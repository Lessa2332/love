<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>üéÉ –ì–∞—Ä–±—É–∑–æ–≤–µ —Å–≤—ñ—Ç–ª–æ</title>

  <!-- ‚úÖ –°–ø–æ—á–∞—Ç–∫—É –ø—ñ–¥–∫–ª—é—á–∞—î–º–æ A-Frame -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.5.0/dist/aframe.min.js"></script>

  <!-- ‚úÖ –ü–æ—Ç—ñ–º MindAR (AR-—Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –º–∞—Ä–∫–µ—Ä—ñ–≤) -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js" defer></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: black;
      font-family: "Comic Sans MS", cursive;
    }

    #loader, #startBtn {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      text-align: center;
    }

    #loader {
      top: 10px;
      color: #ffb347;
      font-size: 18px;
      background: rgba(11, 11, 29, 0.9);
      padding: 8px 12px;
      border-radius: 8px;
    }

    #hint {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 18px;
      color: #fff;
      background: rgba(255, 140, 0, 0.9);
      border-radius: 16px;
      box-shadow: 0 0 20px #ffb347;
      font-size: 18px;
      display: none;
      z-index: 1000;
      animation: glow 2s infinite alternate;
    }

    @keyframes glow {
      from { box-shadow: 0 0 10px #ff8c00; }
      to { box-shadow: 0 0 30px #ffd580; }
    }

    #startBtn {
      top: 110px;
      display: none;
    }

    button {
      background: #ff8c00;
      color: white;
      border: none;
      padding: 10px 16px;
      font-size: 16px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
      cursor: pointer;
    }

    button:hover {
      background: #ffa733;
    }
  </style>
</head>

<body>
  <!-- üì± –ï–ª–µ–º–µ–Ω—Ç–∏ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É -->
  <div id="loader">üéÉ –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä!</div>
  <div id="hint">üé§ –°–∫–∞–∂–∏ —â–æ—Å—å –≥–∞—Ä–±—É–∑—É ‚Äî –≤—ñ–Ω –∑–∞—Å–≤—ñ—Ç–∏—Ç—å—Å—è!</div>
  <div id="startBtn"><button id="btnStart">üéß –ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –∑–≤—É–∫</button></div>

  <!-- üåå AR-—Å—Ü–µ–Ω–∞ -->
  <a-scene
    mindar-image="imageTargetSrc: ./targets.mind; autoStart: true;"
    color-space="sRGB"
    embedded
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    loading-screen="enabled: false"
    renderer="colorManagement: true; alpha: true;"
  >
    <a-assets>
      <a-asset-item id="pumpkinModel" src="./pumpkin.glb"></a-asset-item>
    </a-assets>

    <a-camera position="0 0 0.8"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0" id="target-entity">
      <a-gltf-model
        id="pumpkin"
        src="#pumpkinModel"
        position="0 -0.1 0"
        rotation="0 180 0"
        scale="0.5 0.5 0.5"
      ></a-gltf-model>

      <a-light
        id="pumpkinLight"
        type="point"
        color="#FFA500"
        position="0 0.2 0"
        intensity="0.4"
        distance="3"
        decay="1"
      ></a-light>

      <a-entity
        id="glowSphere"
        geometry="primitive: sphere; radius: 0.2;"
        material="color: #FF9900; opacity: 0.3; transparent: true;"
        position="0 0.2 0"
        scale="1 1 1"
      ></a-entity>

      <a-light type="ambient" color="#ffcc88" intensity="0.4"></a-light>
    </a-entity>

    <a-sky color="#0b0b1d"></a-sky>
    <a-light type="hemisphere" color="#fff4e0" ground-color="#ff6600" intensity="0.2"></a-light>
  </a-scene>

  <script>
    // üß† –ì–æ–ª–æ–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞ —Å—Ü–µ–Ω–∏
    window.addEventListener("DOMContentLoaded", () => {
      const loader = document.getElementById("loader");
      const hint = document.getElementById("hint");
      const startBtnWrap = document.getElementById("startBtn");
      const btnStart = document.getElementById("btnStart");
      const targetEntity = document.getElementById("target-entity");
      const pumpkinLight = document.getElementById("pumpkinLight");
      const glowSphere = document.getElementById("glowSphere");

      let isTargetVisible = false;
      let audioInitialized = false;
      let analyser = null;
      let dataArray = null;

      // üéØ –ö–æ–ª–∏ –º–∞—Ä–∫–µ—Ä –∑–Ω–∞–π–¥–µ–Ω–æ
      targetEntity.addEventListener("targetFound", () => {
        isTargetVisible = true;
        loader.style.display = "none";
        hint.style.display = "block";
        if (!audioInitialized) startBtnWrap.style.display = "block";
      });

      // üëª –ö–æ–ª–∏ –º–∞—Ä–∫–µ—Ä –∑–Ω–∏–∫
      targetEntity.addEventListener("targetLost", () => {
        isTargetVisible = false;
        loader.style.display = "block";
        hint.style.display = "none";
      });

      // üé§ –ó–∞–ø—É—Å–∫ –º—ñ–∫—Ä–æ—Ñ–æ–Ω—É
      btnStart.addEventListener("click", async () => {
        try {
          await initMic();
          audioInitialized = true;
          startBtnWrap.style.display = "none";
        } catch (err) {
          console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø—ñ –¥–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞:", err);
          alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –º—ñ–∫—Ä–æ—Ñ–æ–Ω. –ü–µ—Ä–µ–≤—ñ—Ä –¥–æ–∑–≤–æ–ª–∏ —É –±—Ä–∞—É–∑–µ—Ä—ñ.");
        }
      });

      async function initMic() {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const AudioContextClass = window.AudioContext || window.webkitAudioContext;
        const audioContext = new AudioContextClass();
        const src = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 512;
        analyser.smoothingTimeConstant = 0.8;
        src.connect(analyser);

        dataArray = new Uint8Array(analyser.frequencyBinCount);
        requestAnimationFrame(animateLight);
      }

      function animateLight() {
        if (analyser && dataArray) {
          analyser.getByteFrequencyData(dataArray);
          const avg = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
          const loudness = Math.min(Math.max(avg / 80, 0), 1.5);
          const intensity = Math.min(loudness * 3, 3);
          const glowSize = 1 + loudness * 0.8;

          if (isTargetVisible) {
            pumpkinLight.setAttribute("intensity", (0.2 + intensity).toFixed(2));
            glowSphere.setAttribute("scale", `${glowSize} ${glowSize} ${glowSize}`);
            glowSphere.setAttribute("material", `opacity: ${(0.2 + loudness * 0.3).toFixed(2)}`);
          }
        }
        requestAnimationFrame(animateLight);
      }

      // üß© –î–µ–±–∞–≥-–ø–µ—Ä–µ—Ö–æ–ø–ª–µ–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫
      window.addEventListener("error", (e) => console.error("Window error:", e.message));
      window.addEventListener("unhandledrejection", (e) => console.error("Promise rejection:", e.reason));
    });
  </script>
</body>
</html>
