<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>üéÉ –ì–∞—Ä–±—É–∑–æ–≤–µ —Å–≤—ñ—Ç–ª–æ</title>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: black;
      font-family: "Comic Sans MS", cursive;
    }

    #loader {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: #0b0b1d;
      color: #ffb347;
      font-size: 20px;
      text-align: center;
      z-index: 9999;
    }

    #hint {
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 18px;
      color: #fff;
      background: rgba(255, 140, 0, 0.9);
      border-radius: 16px;
      box-shadow: 0 0 20px #ffb347;
      font-size: 20px;
      animation: glow 2s infinite alternate;
      display: none;
      z-index: 1000;
    }

    @keyframes glow {
      from { box-shadow: 0 0 10px #ff8c00; }
      to { box-shadow: 0 0 30px #ffd580; }
    }
  </style>
</head>

<body>
  <div id="loader">üéÉ –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä!</div>
  <div id="hint">üé§ –°–∫–∞–∂–∏ —â–æ—Å—å –≥–∞—Ä–±—É–∑—É ‚Äî –≤—ñ–Ω –∑–∞—Å–≤—ñ—Ç–∏—Ç—å—Å—è!</div>

  <!-- ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–û: –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫ -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.5.0/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <a-scene
    mindar-image="imageTargetSrc: ./targets.mind; autoStart: true;"
    color-space="sRGB"
    embedded
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    loading-screen="enabled: false"
    renderer="colorManagement: true; alpha: true;"
  >
    <a-assets>
      <a-asset-item id="pumpkinModel" src="./pumpkin.glb"></a-asset-item>
    </a-assets>

    <a-camera position="0 0 0" active="true"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0" id="target-entity">
      <a-gltf-model
        id="pumpkin"
        src="#pumpkinModel"
        position="0 -0.1 0"
        rotation="0 180 0"
        scale="0.5 0.5 0.5"
      ></a-gltf-model>

      <a-light
        id="pumpkinLight"
        type="point"
        color="#FFA500"
        position="0 0.2 0"
        intensity="0.4"
        distance="3"
        decay="1"
      ></a-light>

      <a-entity
        id="glowSphere"
        geometry="primitive: sphere; radius: 0.2;"
        material="color: #FF9900; opacity: 0.3; transparent: true;"
        position="0 0.2 0"
        scale="1 1 1"
      ></a-entity>

      <a-light type="ambient" color="#ffcc88" intensity="0.4"></a-light>
    </a-entity>

    <a-sky color="#0b0b1d"></a-sky>
    <a-light type="hemisphere" color="#fff4e0" ground-color="#ff6600" intensity="0.2"></a-light>
  </a-scene>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // –ß–µ–∫–∞—î–º–æ, –ø–æ–∫–∏ –≤—Å—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–∞—Ç—å—Å—è
      if (typeof AFRAME === 'undefined') {
        console.error('AFrame –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ');
        return;
      }

      const loader = document.getElementById("loader");
      const hint = document.getElementById("hint");
      
      // –ß–µ–∫–∞—î–º–æ, –ø–æ–∫–∏ A-Frame —Å—Ü–µ–Ω–∞ –±—É–¥–µ –≥–æ—Ç–æ–≤–∞
      document.querySelector('a-scene').addEventListener('loaded', function() {
        const targetEntity = document.getElementById("target-entity");
        const pumpkinLight = document.getElementById("pumpkinLight");
        const glowSphere = document.getElementById("glowSphere");

        let isTargetVisible = false;
        let animationId = null;
        let audioContext = null;
        let analyser = null;

        targetEntity.addEventListener("targetFound", () => {
          isTargetVisible = true;
          loader.style.display = "none";
          hint.style.display = "block";
          initMic();
        });

        targetEntity.addEventListener("targetLost", () => {
          isTargetVisible = false;
          loader.style.display = "flex";
          hint.style.display = "none";
          
          // –ó—É–ø–∏–Ω—è—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é –ø—Ä–∏ –≤—Ç—Ä–∞—Ç—ñ –º–∞—Ä–∫–µ—Ä–∞
          if (animationId) {
            cancelAnimationFrame(animationId);
            animationId = null;
          }
          
          // –°–∫–∏–¥–∞—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è —Å–≤—ñ—Ç–ª–∞
          if (pumpkinLight) {
            pumpkinLight.setAttribute("intensity", "0.4");
          }
          if (glowSphere) {
            glowSphere.setAttribute("scale", "1 1 1");
            glowSphere.setAttribute("material", "opacity", "0.3");
          }
        });

        async function initMic() {
          try {
            // –ó—É–ø–∏–Ω—è—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç, —è–∫—â–æ –≤—ñ–Ω —ñ—Å–Ω—É—î
            if (audioContext) {
              await audioContext.close();
            }

            const stream = await navigator.mediaDevices.getUserMedia({ 
              audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: false
              } 
            });
            
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            analyser.smoothingTimeConstant = 0.8;
            
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);

            const dataArray = new Uint8Array(analyser.frequencyBinCount);

            function animateLight() {
              if (!isTargetVisible) {
                if (animationId) {
                  cancelAnimationFrame(animationId);
                  animationId = null;
                }
                return;
              }

              analyser.getByteFrequencyData(dataArray);
              const avg = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
              const loudness = Math.min(avg / 80, 1);
              const intensity = Math.min(0.2 + loudness * 3, 3);
              const glowSize = 1 + loudness * 0.8;

              if (pumpkinLight) {
                pumpkinLight.setAttribute("intensity", intensity.toFixed(2));
              }
              if (glowSphere) {
                glowSphere.setAttribute("scale", `${glowSize} ${glowSize} ${glowSize}`);
                glowSphere.setAttribute("material", "opacity", (0.2 + loudness * 0.3).toFixed(2));
              }

              animationId = requestAnimationFrame(animateLight);
            }

            animateLight();
          } catch (err) {
            console.error("üé§ –ü–æ–º–∏–ª–∫–∞ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞:", err);
            // –ë—ñ–ª—å—à –¥—Ä—É–∂–Ω—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É
            setTimeout(() => {
              alert("üé§ –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ –≤–∏ –Ω–∞–¥–∞–ª–∏ –¥–æ–∑–≤—ñ–ª –Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞.");
            }, 1000);
          }
        }
      });
    });
  </script>
</body>
</html>
